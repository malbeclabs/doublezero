!
ip multicast-routing
!
router pim sparse-mode
   ipv4
      rp address 10.0.0.0 239.0.0.0/24 override
!
vrf instance vrf1
ip routing vrf vrf1
!
hardware access-list update default-result permit
!
default interface Tunnel500
interface Tunnel500
   description USER-MCAST-500
   ip access-group SEC-USER-SUB-MCAST-IN in
   multicast ipv4 boundary SEC-USER-MCAST-BOUNDARY-500-OUT out
   pim ipv4 sparse-mode
   pim ipv4 dr-priority 4294967295
   mtu 9216
   ip address 169.254.0.0/31
   tunnel mode gre
   tunnel source 1.1.1.1
   tunnel destination 2.2.2.2
   tunnel path-mtu-discovery
   tunnel ttl 32
   no shutdown
!
default interface Tunnel501
interface Tunnel501
   description USER-UCAST-501
   vrf vrf1
   mtu 9216
   ip address 169.254.0.2/31
   tunnel mode gre
   tunnel source 3.3.3.3
   tunnel destination 4.4.4.4
   tunnel path-mtu-discovery
   tunnel ttl 32
   no shutdown
!
default interface Tunnel502
interface Tunnel502
   description USER-MCAST-502
   ip access-group SEC-USER-PUB-MCAST-IN in
   multicast ipv4 boundary SEC-USER-MCAST-BOUNDARY-502-OUT out
   pim ipv4 sparse-mode
   pim ipv4 dr-priority 4294967295
   mtu 9216
   ip address 169.254.0.4/31
   tunnel mode gre
   tunnel source 5.5.5.5
   tunnel destination 6.6.6.6
   tunnel path-mtu-discovery
   tunnel ttl 32
   no shutdown
!
default interface Tunnel503
interface Tunnel503
   description USER-MCAST-503
   ip access-group SEC-USER-PUB-MCAST-IN in
   multicast ipv4 boundary SEC-USER-MCAST-BOUNDARY-503-OUT out
   pim ipv4 sparse-mode
   pim ipv4 dr-priority 4294967295
   mtu 9216
   ip address 169.254.0.6/31
   tunnel mode gre
   tunnel source 7.7.7.7
   tunnel destination 8.8.8.8
   tunnel path-mtu-discovery
   tunnel ttl 32
   no shutdown
!
router bgp 65342
   vrf vrf1
      rd 65342:1
      route-target import vpn-ipv4 65342:1
      route-target export vpn-ipv4 65342:1
      router-id 7.7.7.7
      no neighbor 169.254.0.1
      neighbor 169.254.0.1 remote-as 65000
      neighbor 169.254.0.1 passive
      neighbor 169.254.0.1 description USER-500
      neighbor 169.254.0.1 route-map RM-USER-500-IN in
      neighbor 169.254.0.1 route-map RM-USER-500-OUT out
      neighbor 169.254.0.1 maximum-routes 1
      neighbor 169.254.0.1 maximum-accepted-routes 1
      no neighbor 169.254.0.3
      neighbor 169.254.0.3 remote-as 65000
      neighbor 169.254.0.3 passive
      neighbor 169.254.0.3 description USER-501
      neighbor 169.254.0.3 route-map RM-USER-501-IN in
      neighbor 169.254.0.3 route-map RM-USER-501-OUT out
      neighbor 169.254.0.3 maximum-routes 1
      neighbor 169.254.0.3 maximum-accepted-routes 1
      no neighbor 169.254.0.5
      neighbor 169.254.0.5 remote-as 65000
      neighbor 169.254.0.5 passive
      neighbor 169.254.0.5 description USER-502
      neighbor 169.254.0.5 route-map RM-USER-502-IN in
      neighbor 169.254.0.5 route-map RM-USER-502-OUT out
      neighbor 169.254.0.5 maximum-routes 1
      neighbor 169.254.0.5 maximum-accepted-routes 1
      no neighbor 169.254.0.7
      neighbor 169.254.0.7 remote-as 65000
      neighbor 169.254.0.7 passive
      neighbor 169.254.0.7 description USER-503
      neighbor 169.254.0.7 route-map RM-USER-503-IN in
      neighbor 169.254.0.7 route-map RM-USER-503-OUT out
      neighbor 169.254.0.7 maximum-routes 1
      neighbor 169.254.0.7 maximum-accepted-routes 1
!
ip community-list COMM-ALL_USERS permit 21682:1200
ip community-list COMM-ALL_MCAST_USERS permit 21682:1300
!
no route-map RM-USER-500-OUT
route-map RM-USER-500-OUT permit 10
   match community COMM-ALL_MCAST_USERS
!
no route-map RM-USER-501-OUT
route-map RM-USER-501-OUT permit 10
   match community COMM-ALL_USERS
!
no route-map RM-USER-502-OUT
route-map RM-USER-502-OUT permit 10
   match community COMM-ALL_MCAST_USERS
!
no route-map RM-USER-503-OUT
route-map RM-USER-503-OUT permit 10
   match community COMM-ALL_MCAST_USERS
!
no route-map RM-USER-500-IN
route-map RM-USER-500-IN permit 10
   match ip address prefix-list PL-USER-500
   match as-path length = 1
   set community 21682:1300
!
no route-map RM-USER-501-IN
route-map RM-USER-501-IN permit 10
   match ip address prefix-list PL-USER-501
   match as-path length = 1
   set community 21682:1200
!
no route-map RM-USER-502-IN
route-map RM-USER-502-IN permit 10
   match ip address prefix-list PL-USER-502
   match as-path length = 1
   set community 21682:1300
!
no route-map RM-USER-503-IN
route-map RM-USER-503-IN permit 10
   match ip address prefix-list PL-USER-503
   match as-path length = 1
   set community 21682:1300
!
no ip prefix-list PL-USER-500
ip prefix-list PL-USER-500 seq 10 deny 0.0.0.0/0 le 32
!
no ip prefix-list PL-USER-501
ip prefix-list PL-USER-501 seq 10 permit 100.0.0.1/32
!
no ip prefix-list PL-USER-502
ip prefix-list PL-USER-502 seq 10 permit 100.0.0.2/32
!
no ip prefix-list PL-USER-503
ip prefix-list PL-USER-503 seq 10 permit 100.0.0.3/32
!
no ip access-list standard SEC-USER-MCAST-BOUNDARY-500-OUT
ip access-list standard SEC-USER-MCAST-BOUNDARY-500-OUT
   counters per-entry
   permit host 239.0.0.1
   permit host 239.0.0.2
   deny 224.0.0.0/4
!
no ip access-list standard SEC-USER-MCAST-BOUNDARY-502-OUT
ip access-list standard SEC-USER-MCAST-BOUNDARY-502-OUT
   counters per-entry
   permit host 239.0.0.3
   permit host 239.0.0.4
   deny 224.0.0.0/4
!
no ip access-list standard SEC-USER-MCAST-BOUNDARY-503-OUT
ip access-list standard SEC-USER-MCAST-BOUNDARY-503-OUT
   counters per-entry
   deny 224.0.0.0/4
!
no ip access-list SEC-USER-PUB-MCAST-IN
ip access-list SEC-USER-PUB-MCAST-IN
   counters per-entry
   permit ip any 224.0.0.13/32
   permit ip any 239.0.0.0/24
   deny ip any any
!
no ip access-list SEC-USER-SUB-MCAST-IN
ip access-list SEC-USER-SUB-MCAST-IN
   counters per-entry
   permit ip any 224.0.0.13/32
   deny ip any any
!
