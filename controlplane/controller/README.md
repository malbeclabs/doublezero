# DoubleZero Controller

The controller generates device configurations from Solana smart contract state and serves them to agents running on network devices via gRPC.

## Architecture

### Agent-Controller Communication Flow

The controller provides two gRPC endpoints, GetConfig and GetConfigHash, that the config agent (in ../agent/) uses to detect and apply configuration changes. The agent polls the controller every 5 seconds by default. 

The design includes two optimizations:
1. Applying configuration to an Arista EOS device causes the EOS ConfigAgent process CPU to spike, so the agent only applies the config when the config generated by the controller is different than the last polling cycle
2. To make success more likely on lossy networks, 

Here's how the agent uses the endpoints:

```
┌─────────┐                 ┌────────────┐                 ┌────────────┐                  ┌─────────┐
│  Agent  │                 │ Controller │                 │ Controller │                  │   EOS   │
│  main() │                 │GetConfigHash                 │  Config    │                  │ Device  │
│         │                 │ GetConfig()│                 │  Generator │                  │         │
└────┬────┘                 └─────┬──────┘                 └─────┬──────┘                  └────┬────┘
     │                            │                              │                              │
     │ Every 5s:                  │                              │                              │
     │                            │                              │                              │
     │ GetBgpNeighbors()          │                              │                              │
     ├─────────────────────────────────────────────────────────────────────────────────────────►│
     │◄─────────────────────────────────────────────────────────────────────────────────────────┤
     │ [peer IPs]                 │                              │                              │
     │                            │                              │                              │
     │ Decision: should fetch?    │                              │                              │
     │  • First run (no hash)?    │                              │                              │
     │  • 1m since last apply?    │                              │                              │
     │  • Hash changed?           │                              │                              │
     │                            │                              │                              │
     │ GetConfigHashFromServer()  │                              │                              │
     ├───────────────────────────►│                              │                              │
     │                            │ processConfigRequest()       │                              │
     │                            ├─────────────────────────────►│                              │
     │                            │                              │ generateConfig()             │
     │                            │                              │  • deduplicateTunnels()      │
     │                            │                              │  • renderConfig()            │
     │                            │                              │ SHA256(config)               │
     │                            │◄─────────────────────────────┤                              │
     │                            │ [hash only]                  │                              │
     │◄───────────────────────────┤                              │                              │
     │ ConfigHashResponse         │                              │                              │
     │ {hash: "abc123..."}        │                              │                              │
     │ (64 bytes)                 │                              │                              │
     │                            │                              │                              │
     │ Compare: hash != lastHash? │                              │                              │
     │                            │                              │                              │
     ├─── if YES (or first run or 5m timeout):                                                  │
     │                            │                              │                              │
     │    fetchConfigFromController()                            │                              │
     │    ├─► GetConfigFromServer()                              │                              │
     │    │   ──────────────────► │                              │                              │
     │    │                       │ processConfigRequest()       │                              │
     │    │                       ├─────────────────────────────►│                              │
     │    │                       │                              │ generateConfig()             │
     │    │                       │                              │  • deduplicateTunnels()      │
     │    │                       │                              │  • renderConfig()            │
     │    │                       │                              │    (entire config text)      │
     │    │                       │◄─────────────────────────────┤                              │
     │    │   ◄──────────────────│ [config string]               │                              │
     │    │   ConfigResponse      │                              │                              │
     │    │   {config: "..."}     │                              │                              │
     │    │                       │                              │                              │
     │    ├─► computeChecksum(config)                            │                              │
     │    │   [local SHA256]      │                              │                              │
     │    │                       │                              │                              │
     │    └─► return config+hash  │                              │                              │
     │                            │                              │                              │
     │    applyConfig()           │                              │                              │
     │    └─► AddConfigToDevice(config)                          │                              │
     │        ─────────────────────────────────────────────────────────────────────────────────►│
     │        ◄─────────────────────────────────────────────────────────────────────────────────┤
     │        [config applied]    │                              │                              │
     │                            │                              │                              │
     │    lastChecksum = hash     │                              │                              │
     │    lastApplyTime = now     │                              │                              │
     │                            │                              │                              │
     ├─── else: skip this cycle (hash unchanged, no work needed) |                              │
     │                            │                              │                              │
     │ sleep(5s)                  │                              │                              │
     │ goto top                   │                              │                              │
     │                            │                              │                              │
```

**Key Benefits:**
- **Network**: 64 bytes vs ~50KB on most cycles (99%+ reduction when config unchanged)
- **CPU**: Config generation still happens on controller (for hash), but EOS device skips apply
- **Safety**: Full config check every 5 minutes (300s) as fallback
- **Responsiveness**: Still checks for changes every 5 seconds
- **Decision points**: First run, 5m timeout, or hash mismatch triggers full fetch

## Configuration

### ClickHouse Integration

The controller can optionally write GetConfig request metrics to ClickHouse. Configure via environment variables:

```bash
CLICKHOUSE_ADDR=https://your-instance.clickhouse.cloud:8443
CLICKHOUSE_DB=devnet
CLICKHOUSE_USER=controller_devnet
CLICKHOUSE_PASS=your_password
CLICKHOUSE_TLS_DISABLED=false
```

#### Required ClickHouse Permissions

Create the user and grant necessary permissions:

```sql
-- Create user
CREATE USER controller_devnet IDENTIFIED BY 'your_password';

-- Grant permissions
GRANT SELECT, INSERT, CREATE TABLE, SHOW COLUMNS ON devnet.controller_grpc_getconfig_success TO controller_devnet;
```

The controller will automatically create the `controller_grpc_getconfig_success` table on startup and batch-insert GetConfig events every 10 seconds.

#### Table Schema

```sql
CREATE TABLE devnet.controller_grpc_getconfig_success (
    timestamp DateTime64(3),
    device_pubkey LowCardinality(String)
) ENGINE = MergeTree
PARTITION BY toYYYYMM(timestamp)
ORDER BY (timestamp, device_pubkey)
```
