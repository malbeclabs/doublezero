name: promote.mainnet-beta

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to promote (e.g., 0.8.2)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (show what would be copied without copying)'
        required: false
        type: boolean
        default: true

env:
  SOURCE_REPO: malbeclabs/doublezero-testnet
  DEST_REPO: doublezero
  EXPECTED_PACKAGES: >-
    doublezero
    doublezero-activator
    doublezero-agent
    doublezero-controller
    doublezero-device-telemetry-agent
    doublezero-funder
    doublezero-internet-latency-collector
    doublezero-monitor

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.find-packages.outputs.packages }}
      package_count: ${{ steps.find-packages.outputs.count }}
    steps:
      - name: Install Cloudsmith CLI
        run: pip install cloudsmith-cli

      - name: Find packages for version
        id: find-packages
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_TOKEN }}
        run: |
          # Strip trailing -1 if provided, so users can enter either "0.8.4" or "0.8.4-1"
          VERSION="${{ inputs.version }}"
          VERSION="${VERSION%-1}"
          echo "Searching for packages with version $VERSION in $SOURCE_REPO..."

          # Query exact version (rpm) and version with -1 suffix (deb) separately, then merge
          RPM=$(cloudsmith ls pkg $SOURCE_REPO -q "version:^${VERSION}$" -F json -l 100)
          DEB=$(cloudsmith ls pkg $SOURCE_REPO -q "version:^${VERSION}-1$" -F json -l 100)
          PACKAGES=$(jq -s '{data: (.[0].data + .[1].data)}' <(echo "$RPM") <(echo "$DEB"))

          # Extract package names and slugs
          echo "$PACKAGES" | jq -r '.data[] | "\(.name) (\(.slug))"' | sort

          COUNT=$(echo "$PACKAGES" | jq '.data | length')
          echo "Found $COUNT total packages for this version"

          # Filter to only expected packages
          FILTER=$(echo $EXPECTED_PACKAGES | tr ' ' '\n' | jq -R . | jq -s '.')
          SLUGS=$(echo "$PACKAGES" | jq -r --argjson names "$FILTER" '.data[] | select(.name as $n | $names | index($n)) | .slug' | tr '\n' ' ')
          FILTERED_COUNT=$(echo "$PACKAGES" | jq --argjson names "$FILTER" '[.data[] | select(.name as $n | $names | index($n))] | length')

          echo "Filtered to $FILTERED_COUNT packages matching expected list"
          echo "packages=$SLUGS" >> $GITHUB_OUTPUT
          echo "count=$FILTERED_COUNT" >> $GITHUB_OUTPUT

      - name: Validate all expected packages exist
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_TOKEN }}
        run: |
          echo "Validating expected packages..."
          MISSING=""

          VERSION="${{ inputs.version }}"
          VERSION="${VERSION%-1}"

          for pkg in $EXPECTED_PACKAGES; do
            RPM=$(cloudsmith ls pkg $SOURCE_REPO -q "name:^${pkg}$ AND version:^${VERSION}$" -F json)
            DEB=$(cloudsmith ls pkg $SOURCE_REPO -q "name:^${pkg}$ AND version:^${VERSION}-1$" -F json)
            RESULT=$(jq -s '{data: (.[0].data + .[1].data)}' <(echo "$RPM") <(echo "$DEB"))
            COUNT=$(echo "$RESULT" | jq '.data | length')

            if [ "$COUNT" -eq 0 ]; then
              echo "❌ Missing: $pkg"
              MISSING="$MISSING $pkg"
            else
              echo "✅ Found: $pkg"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo ""
            echo "::error::Missing packages:$MISSING"
            exit 1
          fi

          echo ""
          echo "All expected packages found!"

  promote:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Install Cloudsmith CLI
        run: pip install cloudsmith-cli

      - name: Copy packages to mainnet-beta
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_TOKEN }}
        run: |
          echo "Promoting ${{ needs.validate.outputs.package_count }} packages to $DEST_REPO"
          echo "Dry run: ${{ inputs.dry_run }}"
          echo ""

          for slug in ${{ needs.validate.outputs.packages }}; do
            if [ "${{ inputs.dry_run }}" == "true" ]; then
              echo "[DRY RUN] Would copy: $SOURCE_REPO/$slug -> $DEST_REPO"
            else
              echo "Copying: $SOURCE_REPO/$slug -> $DEST_REPO"
              cloudsmith cp $SOURCE_REPO/$slug $DEST_REPO
            fi
          done

          echo ""
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "Dry run complete. Re-run with dry_run=false to copy packages."
          else
            echo "Promotion complete!"
          fi
