name: e2e
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  SHARD_COUNT: "4"
  # Use registry-qualified image names so we can push/pull between jobs
  DZ_IMAGE_REPO: ghcr.io/malbeclabs/dz-e2e
  DZ_IMAGE_TAG: ${{ github.sha }}
  # Individual image refs for the e2e tests
  DZ_BASE_IMAGE: ghcr.io/malbeclabs/dz-e2e/base:${{ github.sha }}
  DZ_LEDGER_IMAGE: ghcr.io/malbeclabs/dz-e2e/ledger:${{ github.sha }}
  DZ_CONTROLLER_IMAGE: ghcr.io/malbeclabs/dz-e2e/controller:${{ github.sha }}
  DZ_ACTIVATOR_IMAGE: ghcr.io/malbeclabs/dz-e2e/activator:${{ github.sha }}
  DZ_MANAGER_IMAGE: ghcr.io/malbeclabs/dz-e2e/manager:${{ github.sha }}
  DZ_FUNDER_IMAGE: ghcr.io/malbeclabs/dz-e2e/funder:${{ github.sha }}
  DZ_DEVICE_IMAGE: ghcr.io/malbeclabs/dz-e2e/device:${{ github.sha }}
  DZ_CLIENT_IMAGE: ghcr.io/malbeclabs/dz-e2e/client:${{ github.sha }}
  DZ_DEVICE_HEALTH_ORACLE_IMAGE: ghcr.io/malbeclabs/dz-e2e/device-health-oracle:${{ github.sha }}

jobs:
  setup:
    runs-on: self-hosted
    permissions:
      packages: write
      contents: read
    outputs:
      matrix: ${{ steps.shard.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Install make
        run: sudo apt-get update && sudo apt-get install -y make
      - name: Build images
        working-directory: e2e/
        run: go run ./cmd/dzctl/main.go build
      - name: Push images to registry
        run: |
          docker push ${{ env.DZ_IMAGE_REPO }}/base:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/ledger:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/controller:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/activator:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/manager:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/funder:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/device:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/client:${{ env.DZ_IMAGE_TAG }}
          docker push ${{ env.DZ_IMAGE_REPO }}/device-health-oracle:${{ env.DZ_IMAGE_TAG }}
      - name: Discover tests and distribute across shards
        id: shard
        working-directory: e2e/
        run: |
          # Find files with exactly the e2e build tag (excludes compound tags like "e2e && stress")
          tests=$(grep -rl '^//go:build e2e$' *_test.go \
            | xargs grep -h '^func TestE2E_' \
            | sed 's/func \(TestE2E_[a-zA-Z0-9_]*\).*/\1/' \
            | sort)

          count=$(echo "$tests" | wc -l)
          echo "Discovered $count tests"
          echo "$tests"

          # Distribute round-robin across shards
          declare -a shards
          for ((i=0; i<SHARD_COUNT; i++)); do
            shards[$i]=""
          done

          i=0
          while IFS= read -r test; do
            idx=$((i % SHARD_COUNT))
            if [ -n "${shards[$idx]}" ]; then
              shards[$idx]="${shards[$idx]}|${test}"
            else
              shards[$idx]="$test"
            fi
            i=$((i + 1))
          done <<< "$tests"

          # Build JSON matrix array
          matrix="["
          for ((i=0; i<SHARD_COUNT; i++)); do
            if [ $i -gt 0 ]; then
              matrix="${matrix},"
            fi
            matrix="${matrix}{\"shard\":$((i + 1)),\"run\":\"^(${shards[$i]})$\"}"
          done
          matrix="${matrix}]"

          echo "Matrix: $matrix"
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  e2e:
    name: e2e (shard ${{ matrix.shard }})
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.setup.outputs.matrix) }}
    defaults:
      run:
        working-directory: "e2e/"
    runs-on: doublezero-k8s-ci
    timeout-minutes: 15
    permissions:
      packages: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Pull pre-built images
        run: |
          pull_with_retry() {
            local image=$1
            local max_attempts=3
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "Pulling $image (attempt $attempt/$max_attempts)"
              if docker pull "$image"; then
                return 0
              fi
              echo "Pull failed, retrying in 5 seconds..."
              sleep 5
              attempt=$((attempt + 1))
            done
            echo "Failed to pull $image after $max_attempts attempts"
            return 1
          }
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/base:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/ledger:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/controller:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/activator:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/manager:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/funder:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/device:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/client:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry ${{ env.DZ_IMAGE_REPO }}/device-health-oracle:${{ env.DZ_IMAGE_TAG }}
          pull_with_retry quay.io/prometheus/prometheus:v2.54.1
          pull_with_retry public.ecr.aws/influxdb/influxdb:1.8
      - name: test
        env:
          DZ_E2E_NO_BUILD: "1"
        run: go test -tags=e2e -timeout=20m -parallel=12 -run '${{ matrix.run }}' -v
