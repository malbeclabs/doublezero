{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "doublezero-lake"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "datasource": {
        "type": "grafana",
        "uid": "doublezero-lake"
      },
      "gridPos": {
        "h": 2,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 15,
      "options": {
        "code": {
          "language": "markdown",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "[â† Back to Overview](/d/doublezero-lake-overview) | [Clear All Filters](/d/doublezero-devices-overview?var-contributor=__ALL__&var-metro=__ALL__&var-device_type=__ALL__&var-status=__ALL__&var-link_type=__ALL__&var-link_bandwidth=__ALL__)"
      },
      "pluginVersion": "10.0.0",
      "title": "",
      "type": "text"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 3,
        "x": 0,
        "y": 2
      },
      "id": 16,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(*) as value FROM dz_devices_current WHERE ('${contributor:raw}' = '__ALL__' OR contributor_pk IN (SELECT pk FROM dz_contributors_current WHERE code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))) AND ('${metro:raw}' = '__ALL__' OR metro_pk IN (SELECT pk FROM dz_metros_current WHERE code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))) AND ('${device_type:raw}' = '__ALL__' OR device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ',')))) AND ('${status:raw}' = '__ALL__' OR status IN (SELECT unnest(string_to_array('${status:raw}', ','))))",
          "refId": "A"
        }
      ],
      "title": "Devices",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 3,
        "x": 3,
        "y": 2
      },
      "id": 17,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(*) as value FROM dz_links_current WHERE ('${contributor:raw}' = '__ALL__' OR contributor_pk IS NULL OR contributor_pk IN (SELECT pk FROM dz_contributors_current WHERE code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))) AND ('${link_type:raw}' = '__ALL__' OR link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ',')))) AND ('${link_bandwidth:raw}' = '__ALL__' OR CAST(bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$')) AND ('${status:raw}' = '__ALL__' OR (CASE WHEN isis_delay_override_ns IS NOT NULL AND isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))))",
          "refId": "A"
        }
      ],
      "title": "Links",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 3,
        "x": 6,
        "y": 2
      },
      "id": 18,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(DISTINCT c.pk) as value FROM dz_contributors_current c WHERE ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))",
          "refId": "A"
        }
      ],
      "title": "Contributors",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 3,
        "x": 9,
        "y": 2
      },
      "id": 19,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT COUNT(*) as value FROM dz_users_current u LEFT JOIN dz_devices_current d ON u.device_pk = d.pk LEFT JOIN dz_metros_current m ON d.metro_pk = m.pk LEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk WHERE u.status = 'activated' AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ',')))) AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ',')))) AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ',')))) AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))))",
          "refId": "A"
        }
      ],
      "title": "Active Users",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 3,
        "x": 12,
        "y": 2
      },
      "id": 20,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT CAST(COALESCE(AVG((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)), 0) AS DOUBLE) as value FROM dz_device_interface_counters_raw u LEFT JOIN dz_devices_current d ON u.device_pk = d.pk LEFT JOIN dz_metros_current m ON d.metro_pk = m.pk LEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk LEFT JOIN dz_links_current l ON u.link_pk = l.pk WHERE u.time >= $__timeFrom() AND u.time <= $__timeTo() AND u.delta_duration > 0 AND u.in_octets_delta >= 0 AND u.out_octets_delta >= 0 AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))) OR (u.link_pk IS NOT NULL AND l.contributor_pk IN (SELECT pk FROM dz_contributors_current WHERE code IN (SELECT unnest(string_to_array('${contributor:raw}', ',')))))) AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ',')))) AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ',')))) AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR (u.link_pk IS NOT NULL AND (CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))))) AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ',')))) AND ('${link_bandwidth:raw}' = '__ALL__' OR l.bandwidth_bps IS NULL OR CAST(l.bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$'))",
          "refId": "A"
        }
      ],
      "title": "Avg Throughput",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 3,
        "x": 15,
        "y": 2
      },
      "id": 21,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT CAST(COALESCE(MAX((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)), 0) AS DOUBLE) as value FROM dz_device_interface_counters_raw u LEFT JOIN dz_devices_current d ON u.device_pk = d.pk LEFT JOIN dz_metros_current m ON d.metro_pk = m.pk LEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk LEFT JOIN dz_links_current l ON u.link_pk = l.pk WHERE u.time >= $__timeFrom() AND u.time <= $__timeTo() AND u.delta_duration > 0 AND u.in_octets_delta >= 0 AND u.out_octets_delta >= 0 AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))) OR (u.link_pk IS NOT NULL AND l.contributor_pk IN (SELECT pk FROM dz_contributors_current WHERE code IN (SELECT unnest(string_to_array('${contributor:raw}', ',')))))) AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ',')))) AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ',')))) AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR (u.link_pk IS NOT NULL AND (CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))))) AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ',')))) AND ('${link_bandwidth:raw}' = '__ALL__' OR l.bandwidth_bps IS NULL OR CAST(l.bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$'))",
          "refId": "A"
        }
      ],
      "title": "Peak Throughput",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 18,
        "y": 2
      },
      "id": 22,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "textMode": "auto",
        "description": "Total WAN link bandwidth capacity and utilization percentage. Only includes WAN links (inter-metro, not in the same metro)."
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  CAST(COALESCE(SUM(l.bandwidth_bps), 0) AS DOUBLE) as \"Total Capacity (bps)\",\n  CASE\n    WHEN SUM(l.bandwidth_bps) > 0 THEN CAST((COALESCE(MAX(peak_throughput.peak_throughput), 0) / SUM(l.bandwidth_bps) * 100.0) AS DOUBLE)\n    ELSE 0.0\n  END as \"Utilization %\"\nFROM dz_links_current l\nJOIN dz_devices_current da ON l.side_a_pk = da.pk\nJOIN dz_devices_current dz ON l.side_z_pk = dz.pk\nLEFT JOIN dz_metros_current ma ON da.metro_pk = ma.pk\nLEFT JOIN dz_metros_current mz ON dz.metro_pk = mz.pk\nLEFT JOIN dz_contributors_current c ON l.contributor_pk = c.pk\nLEFT JOIN (\n  SELECT\n    u.link_pk,\n    MAX((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as peak_throughput\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.link_pk IS NOT NULL\n  GROUP BY u.link_pk\n) peak_throughput ON peak_throughput.link_pk = l.pk\nWHERE\n  l.link_type = 'WAN'\n  AND ma.pk != mz.pk\n  AND ('${contributor:raw}' = '__ALL__' OR c.code IS NULL OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n  AND ('${metro:raw}' = '__ALL__' OR ma.code IS NULL OR mz.code IS NULL OR ma.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))) OR mz.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n  AND ('${device_type:raw}' = '__ALL__' OR da.device_type IS NULL OR dz.device_type IS NULL OR da.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))) OR dz.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n  AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ','))))\n  AND ('${link_bandwidth:raw}' = '__ALL__' OR CAST(l.bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$'))\n  AND ('${status:raw}' = '__ALL__' OR (CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))))",
          "refId": "A"
        }
      ],
      "title": "WAN Capacity & Utilization",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Status"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "palette-classic"
                }
              },
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "activated": {
                        "color": "transparent",
                        "index": 0
                      },
                      "pending": {
                        "color": "yellow",
                        "index": 1
                      },
                      "suspended": {
                        "color": "red",
                        "index": 2
                      },
                      "soft-drained": {
                        "color": "orange",
                        "index": 3
                      },
                      "hard-drained": {
                        "color": "red",
                        "index": 4
                      }
                    },
                    "type": "value"
                  }
                ]
              },
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Status",
                    "url": "d/${__dashboard.uid}?var-status=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Metro"
            },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Metro",
                    "url": "d/${__dashboard.uid}?var-metro=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Contributor"
            },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Contributor",
                    "url": "d/${__dashboard.uid}?var-contributor=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Type"
            },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Device Type",
                    "url": "d/${__dashboard.uid}?var-device_type=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Total Errors"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 1
                    },
                    {
                      "color": "orange",
                      "value": 10
                    },
                    {
                      "color": "red",
                      "value": 100
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Total Discards"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 1
                    },
                    {
                      "color": "orange",
                      "value": 10
                    },
                    {
                      "color": "red",
                      "value": 100
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Avg Throughput (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Max Users"
            },
            "properties": []
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Current Users"
            },
            "properties": []
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Tunnel Capacity %"
            },
            "properties": [
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 50
                    },
                    {
                      "color": "orange",
                      "value": 75
                    },
                    {
                      "color": "red",
                      "value": 90
                    }
                  ]
                }
              },
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Peak Throughput (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "User Tunnel Avg (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "User Tunnel Peak (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Link Avg (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Link Peak (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Internal Avg (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Internal Peak (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 16
      },
      "id": 1,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Total Errors"
          }
        ],
        "enablePagination": true
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  d.code as \"Device\",\n  d.status as \"Status\",\n  d.device_type as \"Type\",\n  m.code as \"Metro\",\n  c.code as \"Contributor\",\n  d.public_ip as \"Public IP\",\n  CAST(COALESCE(errors.total_errors, 0) AS DOUBLE) as \"Total Errors\",\n  CAST(COALESCE(errors.total_discards, 0) AS DOUBLE) as \"Total Discards\",\n  CAST(COALESCE(d.max_users, 0) AS DOUBLE) as \"Max Users\",\n  CAST(COALESCE(user_counts.user_count, 0) AS DOUBLE) as \"Current Users\",\n  CASE\n    WHEN COALESCE(d.max_users, 0) > 0 THEN CAST((COALESCE(user_counts.user_count, 0) * 100.0 / d.max_users) AS DOUBLE)\n    ELSE 0.0\n  END as \"Tunnel Capacity %\",\n  COALESCE(throughput.avg_throughput, 0) as \"Avg Throughput (bps)\",\n  COALESCE(throughput.max_throughput, 0) as \"Peak Throughput (bps)\",\n  COALESCE(user_tunnel_throughput.avg_throughput, 0) as \"User Tunnel Avg (bps)\",\n  COALESCE(user_tunnel_throughput.max_throughput, 0) as \"User Tunnel Peak (bps)\",\n  COALESCE(link_throughput.avg_throughput, 0) as \"Link Avg (bps)\",\n  COALESCE(link_throughput.max_throughput, 0) as \"Link Peak (bps)\",\n  COALESCE(internal_throughput.avg_throughput, 0) as \"Internal Avg (bps)\",\n  COALESCE(internal_throughput.max_throughput, 0) as \"Internal Peak (bps)\"\nFROM dz_devices_current d\nLEFT JOIN dz_metros_current m ON d.metro_pk = m.pk\nLEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk\nLEFT JOIN (\n  SELECT\n    device_pk,\n    COUNT(*) as user_count\n  FROM dz_users_current\n  WHERE status = 'activated'\n  GROUP BY device_pk\n) user_counts ON user_counts.device_pk = d.pk\nLEFT JOIN (\n  SELECT\n    u.device_pk,\n    SUM(GREATEST(COALESCE(u.in_errors_delta, 0), 0) + GREATEST(COALESCE(u.out_errors_delta, 0), 0)) as total_errors,\n    SUM(GREATEST(COALESCE(u.in_discards_delta, 0), 0) + GREATEST(COALESCE(u.out_discards_delta, 0), 0)) as total_discards\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n  GROUP BY u.device_pk\n) errors ON errors.device_pk = d.pk\nLEFT JOIN (\n  SELECT\n    u.device_pk,\n    AVG((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as avg_throughput,\n    MAX((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as max_throughput\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n  GROUP BY u.device_pk\n) throughput ON throughput.device_pk = d.pk\nLEFT JOIN (\n  SELECT\n    u.device_pk,\n    AVG((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as avg_throughput,\n    MAX((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as max_throughput\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.user_tunnel_id IS NOT NULL\n  GROUP BY u.device_pk\n) user_tunnel_throughput ON user_tunnel_throughput.device_pk = d.pk\nLEFT JOIN (\n  SELECT\n    u.device_pk,\n    AVG((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as avg_throughput,\n    MAX((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as max_throughput\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.link_pk IS NOT NULL\n  GROUP BY u.device_pk\n) link_throughput ON link_throughput.device_pk = d.pk\nLEFT JOIN (\n  SELECT\n    u.device_pk,\n    AVG((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as avg_throughput,\n    MAX((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as max_throughput\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.user_tunnel_id IS NULL\n    AND u.link_pk IS NULL\n  GROUP BY u.device_pk\n) internal_throughput ON internal_throughput.device_pk = d.pk\nWHERE\n  ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n  AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n  AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n  AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))))\nORDER BY d.code",
          "refId": "A"
        }
      ],
      "title": "Device Summary",
      "type": "table"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Status"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "palette-classic"
                }
              },
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "activated": {
                        "color": "transparent",
                        "index": 0
                      },
                      "pending": {
                        "color": "yellow",
                        "index": 1
                      },
                      "suspended": {
                        "color": "red",
                        "index": 2
                      },
                      "soft-drained": {
                        "color": "orange",
                        "index": 3
                      },
                      "hard-drained": {
                        "color": "red",
                        "index": 4
                      }
                    },
                    "type": "value"
                  }
                ]
              },
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Status",
                    "url": "d/${__dashboard.uid}?var-status=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Link Type"
            },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Link Type",
                    "url": "d/${__dashboard.uid}?var-link_type=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Contributor"
            },
            "properties": [
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Contributor",
                    "url": "d/${__dashboard.uid}?var-contributor=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Bandwidth (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              },
              {
                "id": "links",
                "value": [
                  {
                    "title": "Filter by Bandwidth",
                    "url": "d/${__dashboard.uid}?var-link_bandwidth=${__value.text}"
                  }
                ]
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Committed RTT (ms)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Measured RTT (ms)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Jitter (ms)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Packet Loss %"
            },
            "properties": [
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 0.1
                    },
                    {
                      "color": "orange",
                      "value": 1.0
                    },
                    {
                      "color": "red",
                      "value": 5.0
                    }
                  ]
                }
              },
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Avg Throughput (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Peak Throughput (bps)"
            },
            "properties": [
              {
                "id": "unit",
                "value": "Bps"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Capacity Utilization %"
            },
            "properties": [
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 50
                    },
                    {
                      "color": "orange",
                      "value": 75
                    },
                    {
                      "color": "red",
                      "value": 90
                    }
                  ]
                }
              },
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Total Errors"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 1
                    },
                    {
                      "color": "orange",
                      "value": 10
                    },
                    {
                      "color": "red",
                      "value": 100
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Total Discards"
            },
            "properties": [
              {
                "id": "custom.cellOptions",
                "value": {
                  "type": "color-background"
                }
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "transparent",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 1
                    },
                    {
                      "color": "orange",
                      "value": 10
                    },
                    {
                      "color": "red",
                      "value": 100
                    }
                  ]
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 22
      },
      "id": 10,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Total Errors"
          }
        ],
        "enablePagination": true
      },
      "pluginVersion": "10.0.0",
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  l.code as \"Link Code\",\n  CASE\n    WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained'\n    ELSE l.status\n  END as \"Status\",\n  l.link_type as \"Link Type\",\n  c.code as \"Contributor\",\n  CAST(l.bandwidth_bps AS DOUBLE) as \"Bandwidth (bps)\",\n  CAST(l.committed_rtt_ns / 1000000.0 AS DOUBLE) as \"Committed RTT (ms)\",\n  COALESCE(measured.avg_rtt_ms, 0) as \"Measured RTT (ms)\",\n  COALESCE(measured.jitter_ms, 0) as \"Jitter (ms)\",\n  COALESCE(measured.packet_loss_pct, 0) as \"Packet Loss %\",\n  COALESCE(throughput.avg_throughput, 0) as \"Avg Throughput (bps)\",\n  COALESCE(throughput.peak_throughput, 0) as \"Peak Throughput (bps)\",\n  CASE\n    WHEN l.bandwidth_bps > 0 THEN CAST((COALESCE(throughput.peak_throughput, 0) / l.bandwidth_bps * 100.0) AS DOUBLE)\n    ELSE 0.0\n  END as \"Capacity Utilization %\",\n  COALESCE(errors.total_errors, 0) as \"Total Errors\",\n  COALESCE(errors.total_discards, 0) as \"Total Discards\"\nFROM dz_links_current l\nLEFT JOIN dz_devices_current da ON l.side_a_pk = da.pk\nLEFT JOIN dz_devices_current dz ON l.side_z_pk = dz.pk\nLEFT JOIN dz_metros_current ma ON da.metro_pk = ma.pk\nLEFT JOIN dz_metros_current mz ON dz.metro_pk = mz.pk\nLEFT JOIN dz_contributors_current c ON l.contributor_pk = c.pk\nLEFT JOIN (\n  SELECT\n    link_pk,\n    AVG(rtt_us / 1000.0) as avg_rtt_ms,\n    STDDEV(rtt_us / 1000.0) as jitter_ms,\n    CAST(COUNT(CASE WHEN rtt_us = 0 OR loss = true THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0) AS DOUBLE) as packet_loss_pct\n  FROM dz_device_link_latency_samples_raw\n  WHERE\n    time >= $__timeFrom()\n    AND time <= $__timeTo()\n  GROUP BY link_pk\n) measured ON measured.link_pk = l.pk\nLEFT JOIN (\n  SELECT\n    u.link_pk,\n    AVG((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as avg_throughput,\n    MAX((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as peak_throughput\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.link_pk IS NOT NULL\n  GROUP BY u.link_pk\n) throughput ON throughput.link_pk = l.pk\nLEFT JOIN (\n  SELECT\n    u.link_pk,\n    SUM(GREATEST(COALESCE(u.in_errors_delta, 0), 0) + GREATEST(COALESCE(u.out_errors_delta, 0), 0)) as total_errors,\n    SUM(GREATEST(COALESCE(u.in_discards_delta, 0), 0) + GREATEST(COALESCE(u.out_discards_delta, 0), 0)) as total_discards\n  FROM dz_device_interface_counters_raw u\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.link_pk IS NOT NULL\n  GROUP BY u.link_pk\n) errors ON errors.link_pk = l.pk\nWHERE\n  ('${contributor:raw}' = '__ALL__' OR c.code IS NULL OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n  AND ('${metro:raw}' = '__ALL__' OR ma.code IS NULL OR mz.code IS NULL OR ma.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))) OR mz.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n  AND ('${device_type:raw}' = '__ALL__' OR da.device_type IS NULL OR dz.device_type IS NULL OR da.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))) OR dz.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n  AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ','))))\n  AND ('${link_bandwidth:raw}' = '__ALL__' OR CAST(l.bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$'))\n  AND ('${status:raw}' = '__ALL__' OR (CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))))\nORDER BY l.code",
          "refId": "A"
        }
      ],
      "title": "Link Summary",
      "type": "table"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Device"
            },
            "properties": [
              {
                "id": "custom.hideFrom",
                "value": {
                  "tooltip": false,
                  "viz": true,
                  "legend": false
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Errors"
            },
            "properties": [
              {
                "id": "unit",
                "value": "short"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 0,
        "y": 40
      },
      "id": 4,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('minute', u.time) as time,\n  d.code as \"Device\",\n  CAST(SUM(GREATEST(COALESCE(u.in_errors_delta, 0), 0) + GREATEST(COALESCE(u.out_errors_delta, 0), 0)) AS DOUBLE) as \"Errors\"\nFROM dz_device_interface_counters_raw u\nJOIN dz_devices_current d ON u.device_pk = d.pk\nLEFT JOIN dz_metros_current m ON d.metro_pk = m.pk\nLEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk\nWHERE\n  u.time >= $__timeFrom()\n  AND u.time <= $__timeTo()\n  AND u.delta_duration > 0\n  AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n  AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n  AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n  AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))))\nGROUP BY date_trunc('minute', u.time), d.code\nORDER BY time, \"Device\"",
          "refId": "A"
        }
      ],
      "title": "Device Errors Over Time",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 0,
        "y": 32
      },
      "id": 5,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('minute', time_bucket) as time,\n  device_code as \"Device\",\n  AVG(total_throughput) as \"Throughput (bps)\"\nFROM (\n  SELECT\n    u.time as time_bucket,\n    d.code as device_code,\n    SUM((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as total_throughput\n  FROM dz_device_interface_counters_raw u\n  JOIN dz_devices_current d ON u.device_pk = d.pk\n  LEFT JOIN dz_metros_current m ON d.metro_pk = m.pk\n  LEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.user_tunnel_id IS NOT NULL\n    AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n    AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n    AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n    AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))))\n  GROUP BY u.time, d.code\n) subq\nGROUP BY date_trunc('minute', time_bucket), device_code\nORDER BY time, \"Device\"",
          "refId": "A"
        }
      ],
      "title": "User Tunnel Throughput",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 6,
        "y": 32
      },
      "id": 8,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('minute', time_bucket) as time,\n  circuit_label as \"Circuit\",\n  AVG(total_throughput) as \"Throughput (bps)\"\nFROM (\n  SELECT\n    u.time as time_bucket,\n    CASE\n      WHEN da.code < dz.code THEN da.code || ' -> ' || dz.code\n      ELSE dz.code || ' -> ' || da.code\n    END as circuit_label,\n    SUM((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as total_throughput\n  FROM dz_device_interface_counters_raw u\n  JOIN dz_links_current l ON u.link_pk = l.pk\n  JOIN dz_devices_current da ON l.side_a_pk = da.pk\n  JOIN dz_devices_current dz ON l.side_z_pk = dz.pk\n  LEFT JOIN dz_metros_current ma ON da.metro_pk = ma.pk\n  LEFT JOIN dz_metros_current mz ON dz.metro_pk = mz.pk\n  LEFT JOIN dz_contributors_current c ON l.contributor_pk = c.pk\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.link_pk IS NOT NULL\n    AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n    AND ('${metro:raw}' = '__ALL__' OR (ma.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))) OR mz.code IN (SELECT unnest(string_to_array('${metro:raw}', ',')))))\n    AND ('${device_type:raw}' = '__ALL__' OR (da.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))) OR dz.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ',')))))\n    AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ','))))\n    AND ('${link_bandwidth:raw}' = '__ALL__' OR CAST(l.bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$'))\n    AND ('${status:raw}' = '__ALL__' OR ((CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR da.status IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR dz.status IN (SELECT unnest(string_to_array('${status:raw}', ',')))))\n  GROUP BY u.time, da.code, dz.code\n) subq\nGROUP BY date_trunc('minute', time_bucket), circuit_label\nORDER BY time, \"Circuit\"",
          "refId": "A"
        }
      ],
      "title": "Link Throughput",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 18,
        "y": 32
      },
      "id": 11,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  time_bucket as time,\n  circuit_label as \"Circuit\",\n  moving_avg_loss_pct as \"Packet Loss % (MA)\"\nFROM (\n  SELECT\n    time_bucket,\n    circuit_label,\n    AVG(loss_pct) OVER (\n      PARTITION BY circuit_label\n      ORDER BY time_bucket\n      ROWS BETWEEN 9 PRECEDING AND CURRENT ROW\n    ) as moving_avg_loss_pct\n  FROM (\n    SELECT\n      date_trunc('minute', s.time) as time_bucket,\n      CASE\n        WHEN dev_o.code < dev_t.code THEN dev_o.code || ' -> ' || dev_t.code\n        ELSE dev_t.code || ' -> ' || dev_o.code\n      END as circuit_label,\n      CAST(COUNT(CASE WHEN s.rtt_us = 0 OR s.loss = true THEN 1 END) * 100.0 / NULLIF(COUNT(*), 0) AS DOUBLE) as loss_pct\n    FROM dz_device_link_latency_samples_raw s\n    JOIN dz_links_current l ON s.link_pk = l.pk\n    LEFT JOIN dz_devices_current dev_o ON s.origin_device_pk = dev_o.pk\n    LEFT JOIN dz_devices_current dev_t ON s.target_device_pk = dev_t.pk\n    LEFT JOIN dz_metros_current mo ON dev_o.metro_pk = mo.pk\n    LEFT JOIN dz_metros_current mt ON dev_t.metro_pk = mt.pk\n    LEFT JOIN dz_contributors_current c_o ON dev_o.contributor_pk = c_o.pk\n    LEFT JOIN dz_contributors_current c_t ON dev_t.contributor_pk = c_t.pk\n    LEFT JOIN dz_contributors_current c_l ON l.contributor_pk = c_l.pk\n    WHERE\n      s.time >= $__timeFrom()\n      AND s.time <= $__timeTo()\n      AND ('${contributor:raw}' = '__ALL__' OR c_o.code IS NULL OR c_t.code IS NULL OR c_l.code IS NULL OR c_o.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))) OR c_t.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))) OR c_l.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n      AND ('${metro:raw}' = '__ALL__' OR mo.code IS NULL OR mt.code IS NULL OR mo.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))) OR mt.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n      AND ('${device_type:raw}' = '__ALL__' OR dev_o.device_type IS NULL OR dev_t.device_type IS NULL OR dev_o.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))) OR dev_t.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n      AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ','))))\n      AND ('${link_bandwidth:raw}' = '__ALL__' OR CAST(l.bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$'))\n      AND ('${status:raw}' = '__ALL__' OR ((CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR dev_o.status IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR dev_t.status IN (SELECT unnest(string_to_array('${status:raw}', ',')))))\n    GROUP BY time_bucket, dev_o.code, dev_t.code\n  ) loss_by_bucket\n) moving_avg\nORDER BY time, \"Circuit\"",
          "refId": "A"
        }
      ],
      "title": "Packet Loss Moving Average",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Discards"
            },
            "properties": [
              {
                "id": "unit",
                "value": "short"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 6,
        "y": 40
      },
      "id": 12,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('minute', u.time) as time,\n  d.code as \"Device\",\n  CAST(SUM(GREATEST(COALESCE(u.in_discards_delta, 0), 0) + GREATEST(COALESCE(u.out_discards_delta, 0), 0)) AS DOUBLE) as \"Discards\"\nFROM dz_device_interface_counters_raw u\nJOIN dz_devices_current d ON u.device_pk = d.pk\nLEFT JOIN dz_metros_current m ON d.metro_pk = m.pk\nLEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk\nWHERE\n  u.time >= $__timeFrom()\n  AND u.time <= $__timeTo()\n  AND u.delta_duration > 0\n  AND u.link_pk IS NULL\n  AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n  AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n  AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n  AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))))\nGROUP BY date_trunc('minute', u.time), d.code\nORDER BY time, \"Device\"",
          "refId": "A"
        }
      ],
      "title": "Device Discards Over Time",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Errors"
            },
            "properties": [
              {
                "id": "unit",
                "value": "short"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 12,
        "y": 40
      },
      "id": 13,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('minute', u.time) as time,\n  CASE\n    WHEN da.code < dz.code THEN da.code || ' -> ' || dz.code\n    ELSE dz.code || ' -> ' || da.code\n  END as \"Circuit\",\n  CAST(SUM(GREATEST(COALESCE(u.in_errors_delta, 0), 0) + GREATEST(COALESCE(u.out_errors_delta, 0), 0)) AS DOUBLE) as \"Errors\"\nFROM dz_device_interface_counters_raw u\nJOIN dz_links_current l ON u.link_pk = l.pk\nJOIN dz_devices_current da ON l.side_a_pk = da.pk\nJOIN dz_devices_current dz ON l.side_z_pk = dz.pk\nLEFT JOIN dz_metros_current ma ON da.metro_pk = ma.pk\nLEFT JOIN dz_metros_current mz ON dz.metro_pk = mz.pk\nLEFT JOIN dz_contributors_current c ON l.contributor_pk = c.pk\nWHERE\n  u.time >= $__timeFrom()\n  AND u.time <= $__timeTo()\n  AND u.delta_duration > 0\n  AND u.link_pk IS NOT NULL\n  AND ('${contributor:raw}' = '__ALL__' OR c.code IS NULL OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n  AND ('${metro:raw}' = '__ALL__' OR ma.code IS NULL OR mz.code IS NULL OR ma.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))) OR mz.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n  AND ('${device_type:raw}' = '__ALL__' OR da.device_type IS NULL OR dz.device_type IS NULL OR da.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))) OR dz.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n  AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ','))))\n  AND ('${link_bandwidth:raw}' = '__ALL__' OR CAST(l.bandwidth_bps AS BIGINT) IN (SELECT CAST(val AS BIGINT) FROM (SELECT unnest(string_to_array('${link_bandwidth:raw}', ',')) as val) WHERE val ~ '^[0-9]+$'))\n  AND ('${status:raw}' = '__ALL__' OR ((CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR da.status IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR dz.status IN (SELECT unnest(string_to_array('${status:raw}', ',')))))\nGROUP BY date_trunc('minute', u.time), da.code, dz.code\nORDER BY time, \"Circuit\"",
          "refId": "A"
        }
      ],
      "title": "Link Errors Over Time",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Discards"
            },
            "properties": [
              {
                "id": "unit",
                "value": "short"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 18,
        "y": 40
      },
      "id": 14,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('minute', u.time) as time,\n  CASE\n    WHEN da.code < dz.code THEN da.code || ' -> ' || dz.code\n    ELSE dz.code || ' -> ' || da.code\n  END as \"Circuit\",\n  CAST(SUM(GREATEST(COALESCE(u.in_discards_delta, 0), 0) + GREATEST(COALESCE(u.out_discards_delta, 0), 0)) AS DOUBLE) as \"Discards\"\nFROM dz_device_interface_counters_raw u\nJOIN dz_links_current l ON u.link_pk = l.pk\nJOIN dz_devices_current da ON l.side_a_pk = da.pk\nJOIN dz_devices_current dz ON l.side_z_pk = dz.pk\nLEFT JOIN dz_metros_current ma ON da.metro_pk = ma.pk\nLEFT JOIN dz_metros_current mz ON dz.metro_pk = mz.pk\nLEFT JOIN dz_contributors_current c ON l.contributor_pk = c.pk\nWHERE\n  u.time >= $__timeFrom()\n  AND u.time <= $__timeTo()\n  AND u.delta_duration > 0\n  AND u.link_pk IS NOT NULL\n  AND ('${contributor:raw}' = '__ALL__' OR c.code IS NULL OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n  AND ('${metro:raw}' = '__ALL__' OR ma.code IS NULL OR mz.code IS NULL OR ma.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))) OR mz.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n  AND ('${device_type:raw}' = '__ALL__' OR da.device_type IS NULL OR dz.device_type IS NULL OR da.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))) OR dz.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n  AND ('${link_type:raw}' = '__ALL__' OR l.link_type IN (SELECT unnest(string_to_array('${link_type:raw}', ','))))\n  AND ('${status:raw}' = '__ALL__' OR ((CASE WHEN l.isis_delay_override_ns IS NOT NULL AND l.isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE l.status END) IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR da.status IN (SELECT unnest(string_to_array('${status:raw}', ','))) OR dz.status IN (SELECT unnest(string_to_array('${status:raw}', ',')))))\nGROUP BY date_trunc('minute', u.time), da.code, dz.code\nORDER BY time, \"Circuit\"",
          "refId": "A"
        }
      ],
      "title": "Link Discards Over Time",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "doublezero-lake"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "tooltip": false,
              "viz": false,
              "legend": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 6,
        "x": 12,
        "y": 32
      },
      "id": 9,
      "options": {
        "legend": {
          "calcs": [
            "mean",
            "lastNotNull"
          ],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "doublezero-lake"
          },
          "editorMode": "code",
          "format": "time_series",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('minute', time_bucket) as time,\n  device_code as \"Device\",\n  AVG(total_throughput) as \"Throughput (bps)\"\nFROM (\n  SELECT\n    u.time as time_bucket,\n    d.code as device_code,\n    SUM((u.in_octets_delta + u.out_octets_delta) * 8.0 / NULLIF(u.delta_duration, 0)) as total_throughput\n  FROM dz_device_interface_counters_raw u\n  JOIN dz_devices_current d ON u.device_pk = d.pk\n  LEFT JOIN dz_metros_current m ON d.metro_pk = m.pk\n  LEFT JOIN dz_contributors_current c ON d.contributor_pk = c.pk\n  WHERE\n    u.time >= $__timeFrom()\n    AND u.time <= $__timeTo()\n    AND u.delta_duration > 0\n    AND u.in_octets_delta >= 0\n    AND u.out_octets_delta >= 0\n    AND u.user_tunnel_id IS NULL\n    AND u.link_pk IS NULL\n    AND ('${contributor:raw}' = '__ALL__' OR c.code IN (SELECT unnest(string_to_array('${contributor:raw}', ','))))\n    AND ('${metro:raw}' = '__ALL__' OR m.code IN (SELECT unnest(string_to_array('${metro:raw}', ','))))\n    AND ('${device_type:raw}' = '__ALL__' OR d.device_type IN (SELECT unnest(string_to_array('${device_type:raw}', ','))))\n    AND ('${status:raw}' = '__ALL__' OR d.status IN (SELECT unnest(string_to_array('${status:raw}', ','))))\n  GROUP BY u.time, d.code\n) subq\nGROUP BY date_trunc('minute', time_bucket), device_code\nORDER BY time, \"Device\"",
          "refId": "A"
        }
      ],
      "title": "Internal Non-Link Throughput",
      "type": "timeseries"
    }
  ],
  "refresh": "30m",
  "schemaVersion": 38,
  "style": "dark",
  "tags": [
    "doublezero",
    "lake",
    "devices"
  ],
  "templating": {
    "list": [
      {
        "allValue": "__ALL__",
        "current": {
          "selected": true,
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "postgres",
          "uid": "doublezero-lake"
        },
        "definition": "SELECT code FROM dz_contributors_current ORDER BY code",
        "description": "Filter by contributor",
        "error": null,
        "hide": 0,
        "includeAll": true,
        "label": "Contributor",
        "multi": true,
        "name": "contributor",
        "options": [],
        "query": "SELECT code FROM dz_contributors_current ORDER BY code",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "__ALL__",
        "current": {
          "selected": true,
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "postgres",
          "uid": "doublezero-lake"
        },
        "definition": "SELECT code FROM dz_metros_current ORDER BY code",
        "description": "Filter by metro",
        "error": null,
        "hide": 0,
        "includeAll": true,
        "label": "Metro",
        "multi": true,
        "name": "metro",
        "options": [],
        "query": "SELECT code FROM dz_metros_current ORDER BY code",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "__ALL__",
        "current": {
          "selected": true,
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "postgres",
          "uid": "doublezero-lake"
        },
        "definition": "SELECT DISTINCT device_type FROM dz_devices_current WHERE device_type IS NOT NULL ORDER BY device_type",
        "description": "Filter by device type",
        "error": null,
        "hide": 0,
        "includeAll": true,
        "label": "Device Type",
        "multi": true,
        "name": "device_type",
        "options": [],
        "query": "SELECT DISTINCT device_type FROM dz_devices_current WHERE device_type IS NOT NULL ORDER BY device_type",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "__ALL__",
        "current": {
          "selected": true,
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "postgres",
          "uid": "doublezero-lake"
        },
        "definition": "SELECT DISTINCT status FROM (SELECT status FROM dz_devices_current WHERE status IS NOT NULL UNION SELECT CASE WHEN isis_delay_override_ns IS NOT NULL AND isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE status END as status FROM dz_links_current WHERE status IS NOT NULL) WHERE status IS NOT NULL ORDER BY status",
        "description": "Filter by status (applies to both devices and links)",
        "error": null,
        "hide": 0,
        "includeAll": true,
        "label": "Status",
        "multi": true,
        "name": "status",
        "options": [],
        "query": "SELECT DISTINCT status FROM (SELECT status FROM dz_devices_current WHERE status IS NOT NULL UNION SELECT CASE WHEN isis_delay_override_ns IS NOT NULL AND isis_delay_override_ns = 1000000000 THEN 'soft-drained' ELSE status END as status FROM dz_links_current WHERE status IS NOT NULL) WHERE status IS NOT NULL ORDER BY status",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "__ALL__",
        "current": {
          "selected": true,
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "postgres",
          "uid": "doublezero-lake"
        },
        "definition": "SELECT DISTINCT link_type FROM dz_links_current WHERE link_type IS NOT NULL ORDER BY link_type",
        "description": "Filter by link type",
        "error": null,
        "hide": 0,
        "includeAll": true,
        "label": "Link Type",
        "multi": true,
        "name": "link_type",
        "options": [],
        "query": "SELECT DISTINCT link_type FROM dz_links_current WHERE link_type IS NOT NULL ORDER BY link_type",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      },
      {
        "allValue": "__ALL__",
        "current": {
          "selected": false,
          "text": "All",
          "value": "$__all"
        },
        "datasource": {
          "type": "postgres",
          "uid": "doublezero-lake"
        },
        "definition": "SELECT DISTINCT CAST(bandwidth_bps AS BIGINT) as __value, CAST(bandwidth_bps / 1000000000.0 AS DOUBLE) || ' Gb/s' as __text FROM dz_links_current WHERE bandwidth_bps IS NOT NULL ORDER BY bandwidth_bps",
        "description": "Filter by link bandwidth",
        "error": null,
        "hide": 0,
        "includeAll": true,
        "label": "Link Bandwidth",
        "multi": true,
        "name": "link_bandwidth",
        "options": [],
        "query": "SELECT DISTINCT CAST(bandwidth_bps AS BIGINT) as __value, CAST(bandwidth_bps / 1000000000.0 AS DOUBLE) || ' Gb/s' as __text FROM dz_links_current WHERE bandwidth_bps IS NOT NULL ORDER BY bandwidth_bps",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      }
    ]
  },
  "time": {
    "from": "now-24h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "",
  "title": "DoubleZero Devices Overview",
  "uid": "doublezero-devices-overview",
  "version": 0,
  "weekStart": ""
}